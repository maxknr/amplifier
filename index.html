<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amplifier Diagnostic and Session Report Tool</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Custom styles for the result grid */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            text-align: center;
        }
        .result-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .dark .result-item {
            background-color: #374151; /* Tailwind gray-700 */
        }
        /* Style for menu items */
        .menu-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1);
        }

        /* --- Styles for Print View (Corrected) --- */
        @media print {
            /* 1. Hide everything on the page by default */
            body * {
                visibility: hidden;
            }
            
            /* 2. Make the report section and its content visible */
            #report-section, #report-section * {
                visibility: visible;
            }
            
            /* 3. Position the report content correctly for printing */
            #report-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                background: white;
                color: black;
                border: none !important;
                box-shadow: none !important;
                font-size: 10pt;
            }

            /* 4. Ensure print-hidden elements are properly removed */
            .print-hidden, .back-to-menu-btn, .report-header {
                display: none !important;
            }
            
            /* 5. Ensure all text is black for printing compatibility */
            h1, h2, h3, p, span, div {
                color: black !important;
                background-color: white !important;
            }

            .report-item {
                border: 1px solid #ccc;
                padding: 10px;
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
        }
    </style>
    <!-- PDF Generation Libraries -->
    <!-- html2canvas is used to convert the HTML content to an image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF is used to create and save the PDF document -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="calculator-card" class="w-full max-w-lg bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-8 space-y-8 transition duration-500">
        
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white text-center">
            Amplifier Diagnostic Toolkit
        </h1>
        
        <p id="error-message" class="text-center text-red-500 text-base font-semibold mb-4 hidden"></p>

        <!-- NAVIGATION MENU GRID -->
        <div id="main-menu" class="grid grid-cols-2 md:grid-cols-3 gap-3 p-4 bg-blue-50 dark:bg-gray-700 rounded-lg shadow-inner border border-blue-200 dark:border-gray-600">
            <!-- Existing Menu Items -->
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-blue-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="power-section">
                <span class="text-xl">‚ö°</span><span class="mt-1">Power & Peak</span>
            </button>
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-teal-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="voltage-section">
                <span class="text-xl">üéØ</span><span class="mt-1">Target Voltage</span>
            </button>
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-orange-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="impedance-section">
                <span class="text-xl">üîå</span><span class="mt-1">Input Impedance</span>
            </button>
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-red-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="output-impedance-section">
                <span class="text-xl">üîä</span><span class="mt-1">Output Impedance</span>
            </button>
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-purple-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="damping-factor-section">
                <span class="text-xl">‚öôÔ∏è</span><span class="mt-1">Damping Factor</span>
            </button>
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-yellow-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="slew-rate-section">
                <span class="text-xl">‚è±Ô∏è</span><span class="mt-1">Slew Rate</span>
            </button>
            <button class="menu-item bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border-b-4 border-lime-500 text-sm font-semibold text-gray-700 dark:text-gray-200 text-center flex flex-col items-center justify-center h-20" data-target="gain-section">
                <span class="text-xl">‚¨ÜÔ∏è</span><span class="mt-1">Voltage Gain</span>
            </button>
            
            <!-- NEW: Report Menu Item -->
            <button id="report-menu-item" class="menu-item bg-blue-600 text-white p-3 rounded-lg shadow-md border-b-4 border-blue-800 text-sm font-semibold text-center flex flex-col items-center justify-center h-20 col-span-2 md:col-span-1" data-target="report-section">
                <span class="text-xl">üìÑ</span><span class="mt-1">Session Report Log</span>
            </button>
        </div>
        
        <!-- CALCULATOR SECTIONS START HERE -->

        <!-- 1. CALCULATE RMS POWER, PEAK VOLTAGE, PEAK CURRENT -->
        <div id="power-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                1. Calculate Power & Peak Outputs
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Find the amplifier's maximum power and voltage/current peaks from measured **RMS voltage** and load resistance.
            </p>
            
            <div class="space-y-4">
                <!-- RMS Voltage Input -->
                <div>
                    <label for="rmsVoltage" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        RMS Voltage Before Clipping
                    </label>
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <input type="number" id="rmsVoltage" placeholder="e.g., 28.3" step="0.1"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg"
                            min="0">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span class="text-gray-500 dark:text-gray-400 sm:text-sm">
                                Volts
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Resistance Input -->
                <div>
                    <label for="resistanceP" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Load Resistance
                    </label>
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <input type="number" id="resistanceP" placeholder="e.g., 4" step="0.1"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg"
                            min="0.1">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span class="text-gray-500 dark:text-gray-400 sm:text-sm">
                                Ohms
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <!-- Calculation Button -->
                    <button id="calculatePowerBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <!-- NEW: Save Button -->
                    <button id="savePowerBtn"
                        class="w-full flex justify-center py-3 px-4 border border-blue-600 rounded-lg shadow-lg text-lg font-semibold text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Power and Peak Values -->
            <div id="result-power-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">
                    Calculated Values:
                </p>

                <div class="result-grid">
                    <!-- RMS Power (Highlighted) -->
                    <div class="result-item !bg-green-100 dark:!bg-green-900/40 border-2 border-green-500">
                        <p class="text-xs font-semibold text-gray-700 dark:text-gray-300">RMS Power</p>
                        <p id="output-power" class="text-2xl font-extrabold text-green-700 dark:text-green-300 mt-1">0.00 W</p>
                    </div>

                    <!-- RMS Voltage (New Addition - for reference) -->
                    <div class="result-item">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Input RMS Voltage</p>
                        <p id="output-voltage-rms-display" class="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">0.00 V</p>
                    </div>

                    <!-- Peak Voltage -->
                    <div class="result-item">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Peak Voltage</p>
                        <p id="output-voltage-peak" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0.00 V</p>
                    </div>

                    <!-- Peak-to-Peak Voltage -->
                    <div class="result-item">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">P-T-P Voltage</p>
                        <p id="output-voltage-ptp" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0.00 V</p>
                    </div>

                    <!-- Peak Current -->
                    <div class="result-item">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Peak Current</p>
                        <p id="output-current-peak" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0.00 A</p>
                    </div>
                </div>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>

        <!-- 2. CALCULATE TARGET VOLTAGE -->
        <div id="voltage-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                2. Calculate Target Voltage
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Find the required voltage to hit a target power level.
            </p>
            
            <div class="space-y-4">
                <!-- Target Power Input -->
                <div>
                    <label for="targetPower" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Target Power
                    </label>
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <input type="number" id="targetPower" placeholder="e.g., 100" step="1"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg"
                            min="1">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span class="text-gray-500 dark:text-gray-400 sm:text-sm">
                                Watts
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Resistance Input -->
                <div>
                    <label for="resistanceV" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Load Resistance
                    </label>
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <input type="number" id="resistanceV" placeholder="e.g., 4" step="0.1"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg"
                            min="0.1">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span class="text-gray-500 dark:text-gray-400 sm:text-sm">
                                Ohms
                            </span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- Calculation Button -->
                    <button id="calculateVoltageBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <!-- NEW: Save Button -->
                    <button id="saveVoltageBtn"
                        class="w-full flex justify-center py-3 px-4 border border-blue-600 rounded-lg shadow-lg text-lg font-semibold text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Voltage -->
            <div id="result-voltage-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                    Required Target RMS Voltage:
                </p>
                <p id="output-voltage" class="text-4xl font-bold text-green-600 dark:text-green-400 mt-2">
                    0.00 V
                </p>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>

        <!-- 3. INPUT IMPEDANCE MEASUREMENT -->
        <div id="impedance-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                3. Input Impedance Measurement
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Calculate the input impedance using the voltage divider method.
            </p>
            
            <div class="space-y-4">
                <!-- Inputs... -->
                <div><label for="voltageNoLoadIn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Voltage RMS No Load</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="voltageNoLoadIn" placeholder="e.g., 0.5" step="0.01" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>
                <div><label for="resistanceKnown" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Known Series Resistor</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="resistanceKnown" placeholder="e.g., 1000" step="1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="1"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Ohms</span></div></div></div>
                <div><label for="voltageLoadIn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Voltage RMS With Load</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="voltageLoadIn" placeholder="e.g., 0.4" step="0.01" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="calculateImpedanceInBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <button id="saveImpedanceInBtn"
                        class="w-full flex justify-center py-3 px-4 border border-blue-600 rounded-lg shadow-lg text-lg font-semibold text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Impedance -->
            <div id="result-impedance-in-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Calculated Input Impedance:</p>
                <p id="output-impedance-in" class="text-4xl font-bold text-green-600 dark:text-green-400 mt-2">0.00 Ohms</p>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>

        <!-- 4. OUTPUT IMPEDANCE MEASUREMENT -->
        <div id="output-impedance-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                4. Output Impedance Measurement
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Calculate the amplifier's internal impedance using the voltage drop across a load.
            </p>
            
            <div class="space-y-4">
                <!-- Inputs... -->
                <div><label for="voltageNoLoadOut" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Voltage RMS No Load</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="voltageNoLoadOut" placeholder="e.g., 20.0" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>
                <div><label for="voltageLoadOut" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Voltage RMS With Load</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="voltageLoadOut" placeholder="e.g., 18.0" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>
                <div><label for="resistanceLoadOut" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Load Resistance</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="resistanceLoadOut" placeholder="e.g., 4" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0.1"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Ohms</span></div></div></div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="calculateImpedanceOutBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <button id="saveImpedanceOutBtn"
                        class="w-full flex justify-center py-3 px-4 border border-blue-600 rounded-lg shadow-lg text-lg font-semibold text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Impedance -->
            <div id="result-impedance-out-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Calculated Output Impedance:</p>
                <p id="output-impedance-out" class="text-4xl font-bold text-green-600 dark:text-green-400 mt-2">0.00 Ohms</p>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>

        <!-- 5. DAMPING FACTOR CALCULATOR -->
        <div id="damping-factor-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                5. Damping Factor Calculator
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Determine the amplifier's damping factor using the speaker load and amplifier output impedance.
            </p>
            
            <div class="space-y-4">
                <!-- Inputs... -->
                <div><label for="resistanceLoadDF" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Load Resistance Speaker Ohms</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="resistanceLoadDF" placeholder="e.g., 8" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0.1"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Ohms</span></div></div></div>
                <div><label for="impedanceOutputDF" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amplifier Output Impedance</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="impedanceOutputDF" placeholder="e.g., 0.05" step="0.001" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0.001"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Ohms</span></div></div></div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="calculateDampingFactorBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <button id="saveDampingFactorBtn"
                        class="w-full flex justify-center py-3 px-4 border border-blue-600 rounded-lg shadow-lg text-lg font-semibold text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Damping Factor -->
            <div id="result-damping-factor-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Calculated Damping Factor:</p>
                <p id="output-damping-factor" class="text-4xl font-bold text-green-600 dark:text-green-400 mt-2">0.00</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Value is unitless</p>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>

        <!-- 6. SLEW RATE CALCULATOR -->
        <div id="slew-rate-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                6. Slew Rate Calculator
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Calculate the Slew Rate using the measured Voltage Change and Rise Time of a square wave output.
            </p>
            
            <div class="space-y-4">
                <!-- Inputs... -->
                <div><label for="voltageChangeSR" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Total Voltage Change</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="voltageChangeSR" placeholder="e.g., 20" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0.1"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>
                <div><label for="riseTimeSR" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rise Time e.g., 10% to 90% point</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="riseTimeSR" placeholder="e.g., 4" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0.01"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">¬µs Microseconds</span></div></div></div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="calculateSlewRateBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <button id="saveSlewRateBtn"
                        class="w-full flex justify-center py-3 px-4 border border-blue-600 rounded-lg shadow-lg text-lg font-semibold text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Slew Rate -->
            <div id="result-slew-rate-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Calculated Slew Rate:</p>
                <p id="output-slew-rate" class="text-4xl font-bold text-green-600 dark:text-green-400 mt-2">0.00 V/¬µs</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Volts per microsecond</p>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>
        
        <!-- 7. VOLTAGE GAIN CALCULATOR -->
        <div id="gain-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                7. Voltage Gain Calculator
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5">
                Calculate Voltage Gain in Ratio and Decibels ($$G_{dB} = 20 \cdot \log_{10}(\frac{V_{out}}{V_{in}})$$
            </p>
            
            <div class="space-y-4">
                <!-- Inputs... -->
                <div><label for="inputVoltageIn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Input RMS Voltage $$V_{in}$$</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="inputVoltageIn" placeholder="e.g., 0.5" step="0.01" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0.000001"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>
                <div><label for="inputVoltageOut" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Output RMS Voltage $$V_{out}$$</label><div class="relative mt-1 rounded-md shadow-sm"><input type="number" id="inputVoltageOut" placeholder="e.g., 10.0" step="0.1" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-3 pr-16 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:text-lg" min="0"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><span class="text-gray-500 dark:text-gray-400 sm:text-sm">Volts</span></div></div></div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="calculateGainBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-lime-600 hover:bg-lime-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95">
                        Calculate
                    </button>
                    <button id="saveGainBtn"
                        class="w-full flex justify-center py-3 px-4 border border-lime-600 rounded-lg shadow-lg text-lg font-semibold text-lime-600 bg-white hover:bg-lime-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500 dark:bg-gray-800 dark:text-lime-400 dark:border-lime-400 dark:hover:bg-gray-700 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                        disabled>
                        Save Result
                    </button>
                </div>
            </div>
            
            <!-- Result Display for Gain -->
            <div id="result-gain-container" class="mt-6 p-4 border-t border-gray-300 dark:border-gray-600 text-center hidden">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Calculated Voltage Gain:</p>
                <div class="result-grid">
                    <!-- Gain Ratio -->
                    <div class="result-item">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Voltage Ratio</p>
                        <p id="output-gain-ratio" class="text-2xl font-bold text-lime-600 dark:text-lime-400 mt-1">0.00:1</p>
                    </div>

                    <!-- Gain dB -->
                    <div class="result-item">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Gain in Decibels</p>
                        <p id="output-gain-db" class="text-2xl font-bold text-lime-600 dark:text-lime-400 mt-1">0.00 dB</p>
                    </div>
                </div>
            </div>
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150">
                ‚Üê Back to Menu
            </button>
        </div>

        <!-- 8. SESSION REPORT LOG (NEW) -->
        <div id="report-section" class="p-5 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                Session Report Log
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-5 print-hidden">
                This log contains all results saved during this session. Use the buttons below to generate a printable or downloadable report.
            </p>
            
            <div id="report-content" class="space-y-4 border-t pt-4 border-gray-300 dark:border-gray-600">
                <!-- Report items will be injected here -->
                <p id="empty-report-message" class="text-center text-gray-500 dark:text-gray-400 italic">No results saved yet.</p>
            </div>

            <div class="mt-6 print-hidden grid grid-cols-2 gap-3">
                <button id="printReportBtn"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                    disabled>
                    Print Report
                </button>
                
                <!-- Download Button (UPDATED FOR PDF) -->
                <button id="downloadPdfBtn"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:focus:ring-offset-gray-900 transition duration-200 ease-in-out transform active:scale-95 disabled:opacity-50"
                    disabled>
                    Download as PDF
                </button>
            </div>
            
            <!-- Back to Menu Button -->
            <button class="back-to-menu-btn text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 mt-4 block w-full text-center cursor-pointer transition duration-150 print-hidden">
                ‚Üê Back to Menu
            </button>
        </div>

    </div>

    <script>
        // Initialize jsPDF globally from the UMD bundle
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State & Initialization ---
            const globalErrorMessage = document.getElementById('error-message');
            // Stores all saved results for the current session
            let sessionResults = []; 
            const printReportBtn = document.getElementById('printReportBtn');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn'); // Updated button ID
            const reportContent = document.getElementById('report-content');
            const saveButtons = document.querySelectorAll('[id^="save"]');

            // --- Navigation Logic ---
            const menuItems = document.querySelectorAll('.menu-item');
            const backToMenuBtns = document.querySelectorAll('.back-to-menu-btn');
            
            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetId = item.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    if (targetId === 'report-section') {
                        generateReport();
                    }
                    if (targetElement) {
                        // The user will see a smooth scroll to the target section
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            backToMenuBtns.forEach(btn => {
                btn.addEventListener('click', scrollToTop);
            });

            // --- Reporting and Printing Logic ---

            /**
             * Generates the report content by iterating over sessionResults array.
             */
            function generateReport() {
                const hasResults = sessionResults.length > 0;
                printReportBtn.disabled = !hasResults;
                downloadPdfBtn.disabled = !hasResults; // Control PDF button state

                if (!hasResults) {
                    reportContent.innerHTML = `<p id="empty-report-message" class="text-center text-gray-500 dark:text-gray-400 italic">No results saved yet.</p>`;
                    return;
                }

                
                const reportHtml = sessionResults.map((result, index) => {
                    // Convert the input/output object into a readable list
                    const detailsHtml = Object.entries(result.details)
                        .map(([key, value]) => `
                            <p class="text-sm font-normal text-gray-700 dark:text-gray-300">
                                <span class="font-semibold">${key}:</span> ${value}
                            </p>
                        `).join('');

                    return `
                        <div class="report-item p-4 border rounded-lg shadow-md bg-white dark:bg-gray-800 transition duration-150">
                            <h3 class="text-lg font-bold text-blue-600 dark:text-blue-400 mb-2">${index + 1}. ${result.title}</h3>
                            ${detailsHtml}
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Saved: ${result.timestamp}</p>
                        </div>
                    `;
                }).join('');

                reportContent.innerHTML = reportHtml;
            }

            /**
             * Triggers the browser's print dialog, which is styled by the @media print CSS block.
             */
            function printReport() {
                window.print();
            }
            
            /**
             * Generates a PDF from the report content using html2canvas and jspdf.
             */
            function downloadReportAsPdf() {
                const reportElement = document.getElementById('report-section');
                
                // Temporarily hide buttons and other non-report elements inside the section for a clean screenshot
                const hiddenElements = reportElement.querySelectorAll('.print-hidden');
                hiddenElements.forEach(el => el.style.display = 'none');
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                html2canvas(reportElement, {
                    scale: 2, // Increase scale for higher resolution
                    useCORS: true,
                    logging: false,
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add image to PDF
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Handle multi-page content (for large reports)
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const now = new Date();
                    const filename = `Amplifier_Diagnostic_Report_${now.toISOString().slice(0, 10).replace(/-/g, '')}.pdf`;
                    pdf.save(filename);

                }).catch(error => {
                    console.error("PDF generation failed:", error);
                    globalErrorMessage.textContent = 'Error: Failed to generate PDF. Check console for details.';
                    globalErrorMessage.classList.remove('hidden');
                }).finally(() => {
                    // Restore visibility of hidden elements
                    hiddenElements.forEach(el => el.style.display = '');
                });
            }

            printReportBtn.addEventListener('click', printReport);
            downloadPdfBtn.addEventListener('click', downloadReportAsPdf);


            // --- Calculation Functions & Save Handlers ---

            /**
             * Stores a calculation result in the sessionResults array.
             * @param {string} title The title of the calculation (e.g., "RMS Power Calculation").
             * @param {object} details An object containing key-value pairs of inputs and outputs.
             */
            function saveResult(title, details) {
                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

                sessionResults.push({
                    title,
                    timestamp,
                    details
                });
                
                // Ensure print and download buttons are enabled
                printReportBtn.disabled = false;
                downloadPdfBtn.disabled = false;
                
                // Call generateReport() here to immediately update the Session Report Log
                generateReport();
            }


            /**
             * Performs validation for positive numeric inputs and voltage comparisons.
             */
            function validateInputs(inputs, mode) {
                globalErrorMessage.classList.add('hidden');
                
                // For most modes, all inputs must be positive numbers
                const areAllPositive = inputs.every(input => !isNaN(input) && input > 0);
                
                if (!areAllPositive) {
                    let message = `Error in ${mode.toUpperCase().replace('_', ' ')} Calculation: Please enter valid, positive numbers for all fields.`;
                    
                    if (mode === 'gain') {
                        const V_IN = inputs[0];
                        if (V_IN <= 0 || isNaN(V_IN)) {
                            message = 'Error in Gain Calculation: Input Voltage ($$V_{in}$$) must be a positive number.';
                        } else if (isNaN(inputs[1]) || inputs[1] < 0) {
                            message = 'Error in Gain Calculation: Output Voltage ($$V_{out}$$) must be a positive number or zero.';
                        } else if (V_IN > 0 && inputs[1] >= 0) {
                            return true; // Valid for Gain
                        }
                    } 

                    globalErrorMessage.textContent = message;
                    globalErrorMessage.classList.remove('hidden');
                    return false;
                }

                if (mode === 'in_impedance' || mode === 'out_impedance') {
                    const V_NL = inputs[0]; 
                    const V_L = mode === 'in_impedance' ? inputs[2] : inputs[1];

                    if (V_NL <= V_L) {
                        globalErrorMessage.textContent = 'Error: Voltage No Load must be greater than Voltage With Load for accurate impedance measurement.';
                        globalErrorMessage.classList.remove('hidden');
                        return false;
                    }
                }
                return true;
            }

            // --- Power Calculation ---
            const voltageInput = document.getElementById('rmsVoltage');
            const resistancePInput = document.getElementById('resistanceP');
            const calculatePowerBtn = document.getElementById('calculatePowerBtn');
            const savePowerBtn = document.getElementById('savePowerBtn');
            const resultPowerContainer = document.getElementById('result-power-container');
            let lastPowerResult = null; // Store the last result to be saved

            function calculateRmsPower() {
                resultPowerContainer.classList.add('hidden');
                savePowerBtn.disabled = true;

                const V_rms = parseFloat(voltageInput.value);
                const R = parseFloat(resistancePInput.value);

                if (!validateInputs([V_rms, R], 'power')) return;

                const pRms = (V_rms * V_rms) / R;
                const V_peak = V_rms * Math.sqrt(2);
                const V_ptp = 2 * V_peak;
                const I_peak = V_peak / R;

                document.getElementById('output-power').textContent = `${pRms.toFixed(2)} W`;
                document.getElementById('output-voltage-rms-display').textContent = `${V_rms.toFixed(2)} V`;
                document.getElementById('output-voltage-peak').textContent = `${V_peak.toFixed(2)} V`;
                document.getElementById('output-voltage-ptp').textContent = `${V_ptp.toFixed(2)} V`;
                document.getElementById('output-current-peak').textContent = `${I_peak.toFixed(2)} A`;
                
                // Store result object for saving
                lastPowerResult = {
                    'Input RMS Voltage': `${V_rms.toFixed(2)} V`,
                    'Load Resistance': `${R.toFixed(1)} Œ©`,
                    'RMS Power (Result)': `${pRms.toFixed(2)} W`,
                    'Peak Voltage': `${V_peak.toFixed(2)} V`,
                    'P-T-P Voltage': `${V_ptp.toFixed(2)} V`,
                    'Peak Current': `${I_peak.toFixed(2)} A`,
                };

                resultPowerContainer.classList.remove('hidden');
                savePowerBtn.disabled = false;
            }

            savePowerBtn.addEventListener('click', () => {
                if (lastPowerResult) {
                    saveResult('RMS Power and Peak Output Calculation', lastPowerResult);
                    savePowerBtn.disabled = true; // Disable after saving
                }
            });
            calculatePowerBtn.addEventListener('click', calculateRmsPower);


            // --- Target Voltage Calculation ---
            const targetPowerInput = document.getElementById('targetPower');
            const resistanceVInput = document.getElementById('resistanceV');
            const calculateVoltageBtn = document.getElementById('calculateVoltageBtn');
            const saveVoltageBtn = document.getElementById('saveVoltageBtn');
            const resultVoltageContainer = document.getElementById('result-voltage-container');
            let lastVoltageResult = null;

            function calculateTargetVoltage() {
                resultVoltageContainer.classList.add('hidden');
                saveVoltageBtn.disabled = true;

                const P = parseFloat(targetPowerInput.value);
                const R = parseFloat(resistanceVInput.value);

                if (!validateInputs([P, R], 'voltage')) return;

                const vRms = Math.sqrt(P * R);

                document.getElementById('output-voltage').textContent = `${vRms.toFixed(2)} V`;
                
                lastVoltageResult = {
                    'Target Power': `${P.toFixed(0)} W`,
                    'Load Resistance': `${R.toFixed(1)} Œ©`,
                    'Required Target RMS Voltage': `${vRms.toFixed(2)} V`,
                };

                resultVoltageContainer.classList.remove('hidden');
                saveVoltageBtn.disabled = false;
            }

            saveVoltageBtn.addEventListener('click', () => {
                if (lastVoltageResult) {
                    saveResult('Target Voltage Calculation', lastVoltageResult);
                    saveVoltageBtn.disabled = true;
                }
            });
            calculateVoltageBtn.addEventListener('click', calculateTargetVoltage);
            
            // --- Input Impedance Calculation ---
            const voltageNoLoadInInput = document.getElementById('voltageNoLoadIn');
            const resistanceKnownInput = document.getElementById('resistanceKnown');
            const voltageLoadInInput = document.getElementById('voltageLoadIn');
            const calculateImpedanceInBtn = document.getElementById('calculateImpedanceInBtn');
            const saveImpedanceInBtn = document.getElementById('saveImpedanceInBtn');
            const resultImpedanceInContainer = document.getElementById('result-impedance-in-container');
            let lastImpedanceInResult = null;

            function calculateInputImpedance() {
                resultImpedanceInContainer.classList.add('hidden');
                saveImpedanceInBtn.disabled = true;

                const V_NL = parseFloat(voltageNoLoadInInput.value);
                const R_K = parseFloat(resistanceKnownInput.value);
                const V_L = parseFloat(voltageLoadInInput.value);

                if (!validateInputs([V_NL, R_K, V_L], 'in_impedance')) return;

                const Z_IN = R_K * (V_L / (V_NL - V_L));

                document.getElementById('output-impedance-in').textContent = `${Z_IN.toFixed(2)} Ohms`;
                
                lastImpedanceInResult = {
                    'Voltage No Load': `${V_NL.toFixed(2)} V`,
                    'Known Series Resistor': `${R_K.toFixed(0)} Œ©`,
                    'Voltage With Load': `${V_L.toFixed(2)} V`,
                    'Calculated Input Impedance': `${Z_IN.toFixed(2)} Œ©`,
                };

                resultImpedanceInContainer.classList.remove('hidden');
                saveImpedanceInBtn.disabled = false;
            }
            saveImpedanceInBtn.addEventListener('click', () => {
                if (lastImpedanceInResult) {
                    saveResult('Input Impedance Calculation', lastImpedanceInResult);
                    saveImpedanceInBtn.disabled = true;
                }
            });
            calculateImpedanceInBtn.addEventListener('click', calculateInputImpedance);

            // --- Output Impedance Calculation ---
            const voltageNoLoadOutInput = document.getElementById('voltageNoLoadOut');
            const voltageLoadOutInput = document.getElementById('voltageLoadOut');
            const resistanceLoadOutInput = document.getElementById('resistanceLoadOut');
            const calculateImpedanceOutBtn = document.getElementById('calculateImpedanceOutBtn');
            const saveImpedanceOutBtn = document.getElementById('saveImpedanceOutBtn');
            const resultImpedanceOutContainer = document.getElementById('result-impedance-out-container');
            let lastImpedanceOutResult = null;

            function calculateOutputImpedance() {
                resultImpedanceOutContainer.classList.add('hidden');
                saveImpedanceOutBtn.disabled = true;

                const V_NL = parseFloat(voltageNoLoadOutInput.value);
                const V_L = parseFloat(voltageLoadOutInput.value);
                const R_L = parseFloat(resistanceLoadOutInput.value);

                if (!validateInputs([V_NL, V_L, R_L], 'out_impedance')) return;

                const Z_OUT = R_L * ((V_NL / V_L) - 1);

                document.getElementById('output-impedance-out').textContent = `${Z_OUT.toFixed(3)} Ohms`;

                lastImpedanceOutResult = {
                    'Voltage No Load': `${V_NL.toFixed(1)} V`,
                    'Voltage With Load': `${V_L.toFixed(1)} V`,
                    'Load Resistance': `${R_L.toFixed(1)} Œ©`,
                    'Calculated Output Impedance': `${Z_OUT.toFixed(3)} Œ©`,
                };
                
                resultImpedanceOutContainer.classList.remove('hidden');
                saveImpedanceOutBtn.disabled = false;
            }
            saveImpedanceOutBtn.addEventListener('click', () => {
                if (lastImpedanceOutResult) {
                    saveResult('Output Impedance Calculation', lastImpedanceOutResult);
                    saveImpedanceOutBtn.disabled = true;
                }
            });
            calculateImpedanceOutBtn.addEventListener('click', calculateOutputImpedance);

            // --- Damping Factor Calculation ---
            const resistanceLoadDFInput = document.getElementById('resistanceLoadDF');
            const impedanceOutputDFInput = document.getElementById('impedanceOutputDF');
            const calculateDampingFactorBtn = document.getElementById('calculateDampingFactorBtn');
            const saveDampingFactorBtn = document.getElementById('saveDampingFactorBtn');
            const resultDampingFactorContainer = document.getElementById('result-damping-factor-container');
            let lastDampingFactorResult = null;

            function calculateDampingFactor() {
                resultDampingFactorContainer.classList.add('hidden');
                saveDampingFactorBtn.disabled = true;

                const R_L = parseFloat(resistanceLoadDFInput.value);
                const Z_OUT = parseFloat(impedanceOutputDFInput.value);

                if (!validateInputs([R_L, Z_OUT], 'damping_factor')) return;

                const DF = R_L / Z_OUT;

                document.getElementById('output-damping-factor').textContent = `${DF.toFixed(2)}`;

                lastDampingFactorResult = {
                    'Load Resistance (Speaker)': `${R_L.toFixed(1)} Œ©`,
                    'Amplifier Output Impedance': `${Z_OUT.toFixed(3)} Œ©`,
                    'Calculated Damping Factor': `${DF.toFixed(2)} (unitless)`,
                };
                
                resultDampingFactorContainer.classList.remove('hidden');
                saveDampingFactorBtn.disabled = false;
            }
            saveDampingFactorBtn.addEventListener('click', () => {
                if (lastDampingFactorResult) {
                    saveResult('Damping Factor Calculation', lastDampingFactorResult);
                    saveDampingFactorBtn.disabled = true;
                }
            });
            calculateDampingFactorBtn.addEventListener('click', calculateDampingFactor);

            // --- Slew Rate Calculation ---
            const voltageChangeSRInput = document.getElementById('voltageChangeSR');
            const riseTimeSRInput = document.getElementById('riseTimeSR');
            const calculateSlewRateBtn = document.getElementById('calculateSlewRateBtn');
            const saveSlewRateBtn = document.getElementById('saveSlewRateBtn');
            const resultSlewRateContainer = document.getElementById('result-slew-rate-container'); 
            let lastSlewRateResult = null;

            function calculateSlewRate() {
                resultSlewRateContainer.classList.add('hidden');
                saveSlewRateBtn.disabled = true;

                const deltaV = parseFloat(voltageChangeSRInput.value);
                const deltaT = parseFloat(riseTimeSRInput.value);

                if (!validateInputs([deltaV, deltaT], 'slew_rate')) return;

                const SR_V_per_uS = deltaV / deltaT;

                document.getElementById('output-slew-rate').textContent = `${SR_V_per_uS.toFixed(2)} V/¬µs`;

                lastSlewRateResult = {
                    'Total Voltage Change': `${deltaV.toFixed(1)} V`,
                    'Rise Time': `${deltaT.toFixed(1)} ¬µs`,
                    'Calculated Slew Rate': `${SR_V_per_uS.toFixed(2)} V/¬µs`,
                };
                
                resultSlewRateContainer.classList.remove('hidden');
                saveSlewRateBtn.disabled = false;
            }
            saveSlewRateBtn.addEventListener('click', () => {
                if (lastSlewRateResult) {
                    saveResult('Slew Rate Calculation', lastSlewRateResult);
                    saveSlewRateBtn.disabled = true;
                }
            });
            calculateSlewRateBtn.addEventListener('click', calculateSlewRate);
            
            // --- Voltage Gain Calculation ---
            const inputVoltageIn = document.getElementById('inputVoltageIn');
            const inputVoltageOut = document.getElementById('inputVoltageOut');
            const calculateGainBtn = document.getElementById('calculateGainBtn');
            const saveGainBtn = document.getElementById('saveGainBtn');
            const resultGainContainer = document.getElementById('result-gain-container');
            let lastGainResult = null;

            function calculateGain() {
                resultGainContainer.classList.add('hidden');
                saveGainBtn.disabled = true;

                const V_IN = parseFloat(inputVoltageIn.value);
                const V_OUT = parseFloat(inputVoltageOut.value);

                if (!validateInputs([V_IN, V_OUT], 'gain')) return;

                const A_v = V_OUT / V_IN;
                let G_dB;
                if (V_OUT === 0) {
                    G_dB = -Infinity; 
                } else {
                    G_dB = 20 * Math.log10(A_v);
                }

                const G_dB_display = G_dB === -Infinity ? `-Inf dB` : `${G_dB.toFixed(2)} dB`;
                
                document.getElementById('output-gain-ratio').textContent = `${A_v.toFixed(2)}:1`;
                document.getElementById('output-gain-db').textContent = G_dB_display;

                lastGainResult = {
                    'Input RMS Voltage ($$V_{in}$$)': `${V_IN.toFixed(2)} V`,
                    'Output RMS Voltage ($$V_{out}$$)': `${V_OUT.toFixed(2)} V`,
                    'Voltage Ratio (Result)': `${A_v.toFixed(2)}:1`,
                    'Gain in Decibels (Result)': G_dB_display,
                };
                
                resultGainContainer.classList.remove('hidden');
                saveGainBtn.disabled = false;
            }
            saveGainBtn.addEventListener('click', () => {
                if (lastGainResult) {
                    saveResult('Voltage Gain Calculation', lastGainResult);
                    saveGainBtn.disabled = true;
                }
            });
            calculateGainBtn.addEventListener('click', calculateGain);


            // --- General Logic for Enter Key and Theme ---
            
            // Re-map Enter key to calculation for all inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        // Find the closest parent section and trigger the calculate button
                        const section = input.closest('[id$="-section"]');
                        if (section) {
                            const calcButton = section.querySelector('[id^="calculate"]');
                            if (calcButton) calcButton.click();
                        }
                    }
                });
            });

            // Basic dark mode simulation
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Initialize report view state on load
            generateReport();
        });
    </script>
</body>
</html>
